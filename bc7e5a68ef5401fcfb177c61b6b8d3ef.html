<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-router history模式下的微信分享小结 | 新时空前端 / 博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="https://www.googletagmanager.com/gtag/js?id=G-1PWBM2M60V" async="true"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1PWBM2M60V');
      </script>
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.50167129.css" as="style"><link rel="preload" href="/assets/js/app.6c99604a.js" as="script"><link rel="preload" href="/assets/js/7.0bb90441.js" as="script"><link rel="preload" href="/assets/js/10.2e3410a3.js" as="script"><link rel="prefetch" href="/assets/js/11.33afebd9.js"><link rel="prefetch" href="/assets/js/12.89769da0.js"><link rel="prefetch" href="/assets/js/2.e88b5140.js"><link rel="prefetch" href="/assets/js/3.4392c754.js"><link rel="prefetch" href="/assets/js/4.c5bf79bd.js"><link rel="prefetch" href="/assets/js/5.9fba2ea6.js"><link rel="prefetch" href="/assets/js/6.fee161fd.js"><link rel="prefetch" href="/assets/js/8.4797a754.js"><link rel="prefetch" href="/assets/js/9.028f96df.js">
    <link rel="stylesheet" href="/assets/css/0.styles.50167129.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container vuepress-theme-simple"><header class="header"><a href="/" title="" class="site-name router-link-active">
      新时空前端 / 博客
    </a> <div style="clear: both"></div> <!----></header> <section class="post-view"><div class="post-head"><h1 class="post-title">
      vue-router history模式下的微信分享小结
    </h1> <time datetime="4/28/2021, 12:00:00 AM" title="4/28/2021, 12:00:00 AM" pubdate="pubdate" class="post-date">
  2 days ago
</time></div> <div class="content__default"><p>参考链接：
<a href="https://m.yisu.com/zixun/178203.html" target="_blank" rel="noopener noreferrer">vue-router history模式下的微信分享小结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://github.com/fa-ge/NativeShare" target="_blank" rel="noopener noreferrer">NativeShare<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>项目场景：
<a href="https://m.xzhuzhai.com/land/houseland/detail-10001.html" target="_blank" rel="noopener noreferrer">共享住宅 wap端 详情页的分享<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>问题：微信浏览器、iOS端、在 vue-router history模式下，遇到的问题。打开页面时分享没有问题，路由一次之后再分享签名错误（invalid signature）</strong></p> <p>原因：微信客户端不支持pushState的H5新特性</p> <p>把第一次打开的页面叫做进入页；把前端路由若干次跳转（通过pushState/replaceState改变url）之后，当前打开的页面叫做当前页。</p> <p>微信验签使用的url（当前网页的URL，不包含#及其后面部分），在Android下取的是当前页url，在IOS下取的是进入页的url（支付目录也是一样）</p> <p>知道了这个，可以采取下面的办法来解决：</p> <ul><li>使用hash模式</li> <li>做成多页应用，每个页面都是进入页</li> <li>所有需要自定义分享的页面使用 <code>&lt;a&gt;</code> 替换 <code>&lt;router-link&gt;</code>，跟2类似，使所有自定义分享页面变成进入页</li></ul> <p>对于我们的业务场景来说，hash模式不能保证历史链接的可用性，多页/ <code>&lt;a&gt;</code> 跳转都是以牺牲一定体验性为代价。</p> <p>经过多番尝试，最后发现用下面的方法勉强解决了问题：</p> <p><strong>我的解决方法</strong></p> <p>使用vuex保存进入页的URL，每次wx.config需要的参数，都使用进入页的URL来进行签名</p> <p>至此，微信分享签名错误的问题解决了，但分享还是不正常</p> <p>进入页面，控制自定义分享前，把当前页URL替换成进入页的URL（保证自定义分享正常）</p> <p>具体代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// middleware/share.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> route<span class="token punctuation">,</span> req<span class="token punctuation">,</span> redirect <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'user/SET_ENTRY_APP_HREF'</span><span class="token punctuation">,</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host <span class="token operator">+</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取微信浏览器中分享的配置参数</span>
<span class="token keyword">async</span> <span class="token function">getShareWxData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.使用进入页的URL来进行签名，解决签名问题</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">isIOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entryAppHref
    <span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
  <span class="token keyword">const</span> <span class="token punctuation">[</span>error<span class="token punctuation">,</span> res<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$xFetch</span><span class="token punctuation">(</span><span class="token function">getWXJSSDK</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shareWxData <span class="token operator">=</span> res<span class="token punctuation">.</span>datas
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2.使用进入页的URL来覆盖本地地址，解决分享的自定义参数生效</span>
<span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">isIOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>entryAppHref
    <span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> href<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>nativeShare <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nativeShare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWeiXin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getShareWxData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nativeShare<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    wechatConfig<span class="token operator">:</span> <span class="token punctuation">{</span>
      appId<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareWxData<span class="token punctuation">.</span>appId<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareWxData<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
      nonceStr<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareWxData<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span>
      signature<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareWxData<span class="token punctuation">.</span>signature
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取分享文案</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getShareData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>nativeShare<span class="token punctuation">.</span><span class="token function">setShareData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  icon<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareData<span class="token punctuation">.</span>img<span class="token punctuation">,</span>
  link<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareData<span class="token punctuation">.</span>link<span class="token punctuation">,</span>
  title<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareData<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
  desc<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shareData<span class="token punctuation">.</span>desc<span class="token punctuation">,</span>
  <span class="token keyword">from</span><span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <div></div></section> <footer class="footer">
  © 2021
  <i class="icon-user"></i> <a href="https://www.nst-fe.site/" target="_blank">
    nst-fe
  </a> <br>
  Powered by
  <a href="https://vuepress.vuejs.org/" rel="noopener" target="_blank">VuePress</a>
  | Theme
  <a href="https://github.com/viko16/vuepress-theme-simple" rel="noopener" target="_blank">Simple</a></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6c99604a.js" defer></script><script src="/assets/js/7.0bb90441.js" defer></script><script src="/assets/js/10.2e3410a3.js" defer></script>
  </body>
</html>
